name: Deploy RedHat CSA Web

on:
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    name: Build and Deploy Frontend & Backend

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Node for frontend
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Build Frontend
      - name: Build Angular Frontend
        working-directory: ./frontend
        run: |
          npm install
          npm run build -- --configuration production

      # 4️⃣ Build Backend Docker image
      - name: Build Backend Docker Image
        working-directory: ./backend
        run: |
          docker build --no-cache \
            -t redhatcsaweb-backend .

      # 5️⃣ Build Frontend Docker image
      - name: Build Frontend Docker Image
        working-directory: ./frontend
        run: |
          docker build --no-cache -t redhatcsaweb-frontend .

      # 6️⃣ Stop & remove old containers if exist
      - name: Stop old containers
        run: |
          docker rm -f rhcsa-backend || true
          docker rm -f rhcsa-frontend || true

      # 7️⃣ Create network and start containers
      - name: Create network & start containers
        run: |
          docker network inspect rhcsa-net >/dev/null 2>&1 || docker network create rhcsa-net

          # Run backend
          docker run -d --name rhcsa-backend \
            --network rhcsa-net \
            -p 8080:8080 \
            -e "PROXMOX__TEMPLATES__SERVER1=${{ secrets.PROXMOX__TEMPLATES__SERVER1 }}" \
            -e "PROXMOX__TEMPLATES__SERVER2=${{ secrets.PROXMOX__TEMPLATES__SERVER2 }}" \
            -e "PROXMOX__TEMPLATES__SERVER3=${{ secrets.PROXMOX__TEMPLATES__SERVER3 }}" \
            -e "PROXMOX__HOST=${{ secrets.PROXMOX__HOST }}" \
            -e "PROXMOX__NODE=${{ secrets.PROXMOX__NODE }}" \
            -e "PROXMOX__APITOKEN=${{ secrets.PROXMOX__APITOKEN }}" \
            -e "PROXMOX__USERNAME=${{ secrets.PROXMOX__USERNAME }}" \
            -e "PROXMOX__PASSWORD=${{ secrets.PROXMOX__PASSWORD }}" \
            redhatcsaweb-backend

          # Run frontend
          docker run -d --name rhcsa-frontend \
            --network rhcsa-net \
            -p 80:80 \
            redhatcsaweb-frontend

      # 8️⃣ Cleanup unused Docker resources after deploy
      - name: Docker Cleanup
        run: |
          docker container prune -f
          docker image prune -a -f
          docker builder prune -a -f
          docker network prune -f
